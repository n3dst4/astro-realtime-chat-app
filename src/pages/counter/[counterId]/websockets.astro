---
import Layout from "../../../layouts/Layout.astro";

const { counterId } = Astro.params;

export const prerender = false;
---

<Layout title="Websockets">
  <meta id="counter-id" data-counter-id={counterId} />
  <p>Counter Value is <em id="counter-value">&mdash;</em></p>

  <p>Connection status: <span id="connection-status">Disconnected</span></p>

  <button class="btn btn-primary" id="increment">Increment</button>
  <button class="btn btn-primary" id="decrement">Decrement</button>
</Layout>
<script>
  import { ReconnectingWebSocket } from "../../../utils/ReconnectingWebSocket";

  let ws: ReconnectingWebSocket | null = null;

  const counterId = document.getElementById("counter-id")?.dataset.counterId;

  function connect() {
    // Determine WebSocket protocol (ws:// or wss://)
    const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
    const host = window.location.host;

    // Build WebSocket URL
    const wsUrl = `${protocol}//${host}/counter/api/${counterId}/ws`;

    // Create WebSocket connection
    ws = new ReconnectingWebSocket(wsUrl, {
      onopen: () => {
        updateConnectionStatus("connected");
      },
      onmessage: (event) => {
        handleMessage(event.data);
      },
      onclose: () => {
        updateConnectionStatus("disconnected");
      },
      onerror: () => {
        updateConnectionStatus("error");
      },
      keepaliveInterval: 30_000,
    });
  }

  connect();

  function updateConnectionStatus(
    status: "connected" | "disconnected" | "error",
  ) {
    const statusElement = document.getElementById("connection-status");
    if (statusElement) {
      statusElement.textContent =
        status.charAt(0).toUpperCase() + status.slice(1);
    }
  }

  function handleMessage(data: any) {
    console.log("Received value", data);
    if (data === "pong") {
      return;
    }
    const span = document.querySelector("#counter-value");
    const { type, payload } = JSON.parse(data);
    if (span && type === "value") {
      span.textContent = payload;
    }
  }

  const incrementButton = document.getElementById("increment");
  incrementButton?.addEventListener("click", async () => {
    ws?.send(JSON.stringify({ type: "increment" }));
  });
  const decrementButton = document.getElementById("decrement");

  decrementButton?.addEventListener("click", async () => {
    ws?.send(JSON.stringify({ type: "decrement" }));
  });
  const refreshButton = document.getElementById("refresh");

  refreshButton?.addEventListener("click", async () => {
    // POST to /counter/api/{counterId}/increment
    const response = await fetch(`/counter/api/${counterId}`);
    if (!response.ok) {
      throw new Error(`Failed to fetch counter: ${response.statusText}`);
    }
    const newValue = await response.text();
    const span = document.querySelector("#counter-value");
    if (span) {
      span.textContent = newValue;
    }
  });
</script>
