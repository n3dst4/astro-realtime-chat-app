---
import Layout from "../../../layouts/Layout.astro";

import {env} from "cloudflare:workers";
const {counterId} = Astro.params;
---

<Layout>

<meta id="counter-id" data-counter-id={counterId}></meta>
<h1>Websockets! Counter Value is <span id="counter-value">&mdash;</span></h1>

<p>Connection status: <span id="connection-status">Disconnected</span></p>

<button id="increment">Increment</button>
<button id="decrement">Decrement</button>

</Layout>


<script>
  import {ReconnectingWebSocket} from "../../../utils/ReconnectingWebSocket"


  let ws: ReconnectingWebSocket|null = null;
  let connected: "connected"|"disconnected"|"error" = "disconnected";

  const counterId = document.getElementById("counter-id")?.dataset.counterId;

  function connect() {
    // Determine WebSocket protocol (ws:// or wss://)
    const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
    const host = window.location.host;

    // Build WebSocket URL
    const wsUrl = `${protocol}//${host}/counter/api/${counterId}/ws`;

    // Create WebSocket connection
    ws = new ReconnectingWebSocket(wsUrl, {
      onopen: () => {
        updateConnectionStatus("connected");
      },
      onmessage: (event) => {
        handleMessage(event.data);
      },
      onclose: (event) => {
        updateConnectionStatus("disconnected");
      },
      onerror: (error) => {
        updateConnectionStatus("error");
      },
      keepaliveInterval: 30_000
    });
  }

  connect();

  function updateConnectionStatus(status: "connected"|"disconnected"|"error") {
    const statusElement = document.getElementById('connection-status');
    if (statusElement) {
      statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    }
  }

  function handleMessage(data: any) {
    console.log("Received value", data);
    if (data === "pong") {
      return;
    }
    const span = document.querySelector('#counter-value');
    const {type, payload} = JSON.parse(data);
    if (span && type==="value") {
      span.textContent = payload;
    }
  }

  const incrementButton = document.getElementById('increment');
  incrementButton?.addEventListener('click', async () => {
    ws?.send(JSON.stringify({type: "increment"}))
  });
  const decrementButton = document.getElementById('decrement');

  decrementButton?.addEventListener('click', async () => {
    ws?.send(JSON.stringify({type: "decrement"}))

  });
  const refreshButton = document.getElementById('refresh');

  refreshButton?.addEventListener('click', async () => {
    // POST to /counter/api/{counterId}/increment
    const response = await fetch(`/counter/api/${counterId}`);
    if (!response.ok) {
      throw new Error(`Failed to fetch counter: ${response.statusText}`);
    }
    const newValue = await response.text();
    const span = document.querySelector('#counter-value');
    if (span) {
      span.textContent = newValue;
    }
  });

</script>
